import org.gradle.api.tasks.testing.logging.TestExceptionFormat

import javax.xml.parsers.DocumentBuilderFactory
import java.security.MessageDigest
import java.util.jar.JarEntry
import java.util.jar.JarFile
import java.util.jar.JarOutputStream

plugins {
    id 'java'
    id 'war'
}

group = 'org.viacheslav'
version = '1.0'

repositories {
    mavenCentral()
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

dependencies {
//    implementation 'org.apache.ant:ant-jsch:1.10.13'
//    implementation("junit:junit:4.13.2")
    // Jakarta EE API (–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, scope provided)
    implementation 'jakarta.platform:jakarta.jakartaee-web-api:9.0.0'
    // Jakarta CDI (Contexts and Dependency Injection)
    implementation 'jakarta.enterprise:jakarta.enterprise.cdi-api:4.0.1'

    // PrimeFaces
    implementation 'org.primefaces:primefaces:14.0.6:jakarta'

    // PrimeFlex
    implementation 'org.webjars.npm:primeflex:3.3.1'
    // PrimeIcons
    implementation 'org.webjars.npm:primeicons:7.0.0'

    // Hibernate ORM
    implementation 'org.hibernate:hibernate-core:6.6.1.Final'

    // PostgreSQL JDBC Driver
    implementation 'org.postgresql:postgresql:42.7.4'
    runtimeOnly 'org.postgresql:postgresql:42.7.4'

    // Lombok –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
//    implementation 'org.projectlombok:lombok:1.18.34'
    compileOnly 'org.projectlombok:lombok:1.18.30'
    annotationProcessor 'org.projectlombok:lombok:1.18.30'

    // –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º JUnit 5
    testRuntimeOnly("junit:junit:4.13.2")
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine:5.9.2")
    testImplementation("junit:junit:4.13.2")
    testImplementation("org.junit.jupiter:junit-jupiter-api:5.9.2")
}

sourceSets {
    main {
        java.srcDirs = ['src/main/java']
    }
    test {
        java.srcDirs = ['src/test/java']
        compileClasspath += sourceSets.main.output + configurations.testCompileClasspath
        runtimeClasspath += sourceSets.main.output + configurations.testRuntimeClasspath
    }
}


war {
    archiveFileName = 'fse-3.war'
    webAppDirectory = file('src/main/webapp')
    from sourceSets.main.output.classesDirs
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    // destinationDirectory.set(file("$buildDir/classes/java/main"))
//    classpath = sourceSets.main.compileClasspath
}

task downloadDependencies(type: Copy) {
    from configurations.runtimeClasspath
    into 'lib' // –ø–∞–ø–∫–∞, –∫—É–¥–∞ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
}


sourceSets {
    main {

        resources {
            srcDirs = ['src/main/resources']
        }

    }

}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞
ext {
    mainClass = 'com.example.Main'
    scpHost = 'user@example.com:/path/to/deploy'
    envProperties = file('env.properties')
    diffProperties = file('diff.properties')
    replaceProperties = file('replace.properties')
    localizationDir = file('src/main/webapp/resources')
}


// 1. COMPILE work
tasks.register("mycompile") {
    group = "build"
    description = "–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞."
    dependsOn("classes")
}

// 2. BUILD work
tasks.register("mybuild") {
    group = "build"
    description = "–°–±–æ—Ä–∫–∞ jar/war-—Ñ–∞–π–ª–∞."
    dependsOn("mycompile", "mynative2ascii", "jar", "war")
}

// 3. CLEAN work
tasks.register('myclean', Delete) {
    group = 'build'
    description = '–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.'
    delete buildDir
}

gradle.projectsEvaluated {
    println ">>> main.java.srcDirs = ${sourceSets.main.java.srcDirs}"
    println ">>> test.java.srcDirs = ${sourceSets.test.java.srcDirs}"
    println ">>> test.classesDirs = ${sourceSets.test.output.classesDirs.files}"
}

// 4. TEST work
task fullTest(type: Test) {
    group = "verification"
    description = "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏."

    useJUnit()  // –ò—Å–ø–æ–ª—å–∑—É–µ–º JUnit4

    reports {
        html.required = true
        junitXml.required = true
        html.outputLocation = layout.buildDirectory.dir("reports/tests/fullTest")
        junitXml.outputLocation = layout.buildDirectory.dir("test-results/fullTest")
    }

    testLogging {
        events "started", "passed", "skipped", "failed", "standard_out", "standard_error"
        showStandardStreams = true
        exceptionFormat "full"
        showExceptions = true
        showCauses = true
        showStackTraces = true
    }

    dependsOn 'classes'
    dependsOn 'compileTestJava'
}


// 5. SPECIAL work
tasks.register("specLaunch") {
    group = "media"
    description = "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ –∏–ª–∏ –º—É–∑—ã–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏."
    doLast {
        println("–ó–∞–ø—É—Å–∫ `mybuild` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ...")

        def result = exec {
            commandLine("./gradlew", "mybuild")
            setIgnoreExitValue(true)
        }

        if (result.exitValue == 0) {
            println("–°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ.")
            exec { commandLine("xdg-open", "cringe.mp4") }
        } else {
            println("–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π, –∑–∞–ø—É—Å–∫–∞–µ–º –º—É–∑—ã–∫—É.")
            exec { commandLine("xdg-open", "tilt.mp3") }
        }
    }

}


// 6. SCP work
tasks.register("myscp") {
    group = "custom"
    description = "–ü–µ—Ä–µ–¥–∞—á–∞ –ø–æ SCP –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏."
    dependsOn("mybuild")
    doLast {
        def warFile = file("build/libs/fse-3.war")
        if (warFile.exists()) {
            println("üì§ –ü–µ—Ä–µ–¥–∞—á–∞ –ø–æ SCP...")
            exec { commandLine("scp", "/home/slava-linux/fse-3/build/libs/fse-3.war", "helios:/home/studs/s409331/fse-3") }
        }

    }
}

// === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
def classesDir = file("$buildDir/classes/java/main")

// 7. DOC work
task doc(dependsOn: [mybuild, javadoc]) {
    doLast {
        // 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é –≤—Å–µ—Ö .class —Ñ–∞–π–ª–æ–≤
        def allClassesTemp = file("${buildDir}/all_classes.tmp")
        allClassesTemp.withOutputStream { out ->
            fileTree(dir: "${buildDir}/classes/java/main").each { file ->
                if (file.name.endsWith('.class')) {
                    out << file.bytes
                }
            }
        }

        // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º MD5 –∏ SHA-1 –¥–ª—è –≤—Å–µ—Ö .class —Ñ–∞–π–ª–æ–≤
        def md5Hash = digest(allClassesTemp, 'MD5')
        def sha1Hash = digest(allClassesTemp, 'SHA-1')

        // 3. –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        allClassesTemp.delete()

        // 4. –û–±–Ω–æ–≤–ª—è–µ–º MANIFEST.MF –≤ –æ—Å–Ω–æ–≤–Ω–æ–º JAR-—Ñ–∞–π–ª–µ
        def jarFile = tasks.named('jar').get().archiveFile.get().asFile

        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –Ω–æ–≤–æ–≥–æ JAR
        def tempJar = file("${jarFile.parent}/temp_${jarFile.name}")

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π JAR –∏ –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ —Å—Ç–∞—Ä–æ–≥–æ MANIFEST.MF
        new JarOutputStream(tempJar.newOutputStream()).withCloseable { jos ->
            new JarFile(jarFile).withCloseable { jar ->
                jar.entries().each { entry ->
                    if (entry.name != 'META-INF/MANIFEST.MF') {
                        jos.putNextEntry(new JarEntry(entry.name))
                        jar.getInputStream(entry).withCloseable { jos << it }
                        jos.closeEntry()
                    }
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π MANIFEST —Å —Ö–µ—à–∞–º–∏
                def manifest = new java.util.jar.Manifest()
                manifest.mainAttributes.putValue('Manifest-Version', '1.0')
                manifest.mainAttributes.putValue('Created-By', 'petrovviacheslav')
                manifest.mainAttributes.putValue('Version', '1.0')
                manifest.mainAttributes.putValue('Classes-MD5', md5Hash)
                manifest.mainAttributes.putValue('Classes-SHA1', sha1Hash)

                jos.putNextEntry(new JarEntry('META-INF/MANIFEST.MF'))
                manifest.write(jos)
                jos.closeEntry()
            }
        }

        // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π JAR –Ω–æ–≤—ã–º
        jarFile.delete()
        tempJar.renameTo(jarFile)

        // 5. –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π JAR —Å javadoc
        def javadocJar = file("${buildDir}/libs/${project.name}-javadoc.jar")

        new JarOutputStream(javadocJar.newOutputStream()).withCloseable { jos ->
            // –î–æ–±–∞–≤–ª—è–µ–º MANIFEST
            def manifest = new java.util.jar.Manifest()
            manifest.mainAttributes.putValue('Manifest-Version', '1.0')
            manifest.mainAttributes.putValue('Created-By', 'petrovviacheslav')
            manifest.mainAttributes.putValue('Version', '1.0')

            jos.putNextEntry(new JarEntry('META-INF/MANIFEST.MF'))
            manifest.write(jos)
            jos.closeEntry()

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã javadoc
            fileTree(dir: "${buildDir}/docs/javadoc").each { file ->
                def entryName = file.path.substring("${buildDir}/docs/javadoc/".length())
                jos.putNextEntry(new JarEntry(entryName))
                file.withInputStream { jos << it }
                jos.closeEntry()
            }
        }

        println "JAR with MANIFEST (MD5: ${md5Hash}, SHA1: ${sha1Hash}) and Javadoc created!"
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ö–µ—à–µ–π
static def digest(File file, String algorithm) {
    def digest = MessageDigest.getInstance(algorithm)
    file.eachByte(4096) { buffer, bytesRead ->
        digest.update(buffer, 0, bytesRead)
    }
    digest.digest().encodeHex().toString()
}

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É javadoc
javadoc {
    destinationDir = file("${buildDir}/docs/javadoc")
    options {
        author = true
        version = true
        use = true
        windowTitle = "Project API"
    }
}

// 8. myvalidateXML work
tasks.register('myvalidateXML') {
    group = 'verification'
    description = '–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö XML-—Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.'
    doLast {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ XML-—Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
        def xmlFiles = fileTree(dir: 'src', include: '**/*.xml')

        // –°–æ–∑–¥–∞—ë–º —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ XML
        def factory = DocumentBuilderFactory.newInstance()
        // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ DTD –∏–ª–∏ XSD:
        factory.setValidating(false)
        factory.setNamespaceAware(true)

        def builder = factory.newDocumentBuilder()

        println "–ù–∞–π–¥–µ–Ω–æ XML-—Ñ–∞–π–ª–æ–≤: ${xmlFiles.files.size()}"

        xmlFiles.each { xmlFile ->
            println "–ü—Ä–æ–≤–µ—Ä—è–µ–º XML-—Ñ–∞–π–ª: ${xmlFile}"
            try {
                // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ñ–∞–π–ª. –ï—Å–ª–∏ XML –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äì –≤—ã–±—Ä–æ—Å–∏—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
                builder.parse(xmlFile)
            } catch (Exception e) {
                throw new GradleException("–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ ${xmlFile}: ${e.message}", e)
            }
        }
        println "–í—Å–µ XML-—Ñ–∞–π–ª—ã –≤–∞–ª–∏–¥–Ω—ã!"
    }
}


// 9. mynative2ascii work
tasks.register('mynative2ascii') {
    group = 'build'
    description = '–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç .properties —Ñ–∞–π–ª—ã –∏–∑ native encoding –≤ ASCII.'

    def inputDir = file('src/main/webapp/resources/resources-native')           // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ${resources.dir}
    def outputDir = file("build/resources")   // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ${build.dir}/resources/resources-native
    doLast {
        if (!inputDir.exists()) {
            throw new GradleException("–í—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $inputDir")
        }

        // –°–æ–∑–¥–∞—ë–º –≤—ã—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        outputDir.mkdirs()

        inputDir.eachFileRecurse { file ->
            if (file.name.endsWith('.properties')) {
                def relativePath = inputDir.toPath().relativize(file.toPath()).toString()
                def outputFile = new File(outputDir, relativePath)

                // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–∞–¥–æ
                outputFile.parentFile.mkdirs()

                // –ó–∞–≥—Ä—É–∂–∞–µ–º .properties –≤ –ø–∞–º—è—Ç—å
                def props = new Properties()
                file.withReader('UTF-8') { reader ->
                    props.load(reader)
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ native2ascii
                outputFile.withWriter('ASCII') { writer ->
                    props.store(writer, null)
                }

                println "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω: ${file} -> ${outputFile}"
            }
        }
    }
}

// 10. myreport work
task myreport(dependsOn: fullTest) {
    doLast {
        copy {
            from file('build/test-results/fullTest/TEST-PointTest.xml')
            into file('.')
        }
        def testResults = file("TEST-PointTest.xml")
        if (testResults.exists()) {
            println "–¥—â–¥"
            exec { commandLine('svn', 'add', "${testResults}", "--force") }
            exec { commandLine('svn', 'commit', "-m", "'Adding test report'") }
        }
    }
}

// 11. work!!!!
task myenv(dependsOn: mycompile) {
    group = 'env'
    description = '–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ'

    def srcDir = file("src/main/java")
    def buildOutput = file("build/libs/fse-3.war") // –∏–ª–∏ –¥—Ä—É–≥–æ–π –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª
    def scpDir = file("/home/slava-linux/wildfly-34.0.0.Final/standalone/deployments")
    def envScript = file("/home/slava-linux/wildfly-34.0.0.Final/bin/standalone.sh") // –ø—É—Ç—å –¥–æ —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞

    inputs.dir(srcDir)
    outputs.dir(classesDir)

    doLast {
        // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∫–ª–∞—Å—Å–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        classesDir.mkdirs()

        exec { commandLine("./gradlew", "mynative2ascii") }
        // exec { commandLine("./gradlew", "jar") }
        exec { commandLine("./gradlew", "war") }

        // –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏ –≤ –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É
        copy {
            from buildOutput
            into scpDir
        }

        // –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å—Ä–µ–¥—ã
        if (!envScript.exists()) {
            throw new GradleException("–°–∫—Ä–∏–ø—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: $envScript")
        }

        exec {
            executable = envScript.absolutePath
        }
    }
}


//// 12. diff work
task diff {
    group = "version control"
    description = "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ SVN –∏ –∫–æ–º–º–∏—Ç–∏—Ç, –µ—Å–ª–∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–æ–ø—É—Å—Ç–∏–º—ã."

    def allowedChangesFile = file("allowed-classes.txt") // —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø—É—Ç–µ–π/–∫–ª–∞—Å—Å–æ–≤

    doLast {
        def allowedPatterns = allowedChangesFile.readLines().findAll { it?.trim() }

        def statusOutput = new ByteArrayOutputStream()
        exec {
            commandLine "svn", "status"
            standardOutput = statusOutput
        }

        def modifiedFiles = statusOutput.toString("UTF-8").readLines()
                .findAll { it.startsWith("M ") || it.startsWith("A ") || it.startsWith("D ") }
                .collect { it.substring(2).trim() }

        def forbidden = modifiedFiles.findAll { filePath ->
            !allowedPatterns.any { pattern -> filePath.contains(pattern) }
        }

        if (forbidden.isEmpty()) {
            println "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:"
            forbidden.each { println " - $it" }
            throw new GradleException("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã. –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω—ë–Ω.")
        }

        // –ö–æ–º–º–∏—Ç–∏–º —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        exec {
            commandLine "svn", "commit", "-m", "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        }

        println "‚úÖ –ö–æ–º–º–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω."
    }
}


//// –¶–µ–ª—å team
//task team(dependsOn: build) {
//    doLast {
//        def revisions = []
//        "svn log -l 3".execute().text.eachLine { line ->
//            def matcher = line =~ /^r(\d+)/
//            if (matcher) {
//                revisions << matcher[0][1]
//            }
//        }
//
//        revisions.each { rev ->
//            "svn up -r ${rev}".execute().waitFor()
//            tasks.build.execute()
//            ant.zip(destfile: "build/revision-${rev}.zip") {
//                fileset(dir: 'build/libs') {
//                    include(name: '*.jar')
//                }
//            }
//        }
//    }
//}
//
//// –¶–µ–ª—å history
//task history {
//    doLast {
//        def currentRev = "svn info".execute().text.readLines().find { it.startsWith('Revision:') }?.split(':')?.last()?.trim()
//        def workingRev = null
//
//        while (currentRev) {
//            try {
//                "svn up -r ${currentRev}".execute().waitFor()
//                tasks.compile.execute()
//                workingRev = currentRev
//                break
//            } catch (e) {
//                currentRev = currentRev.toInteger() - 1
//                if (currentRev <= 0) break
//            }
//        }
//
//        if (workingRev) {
//            def nextRev = workingRev.toInteger() + 1
//            def diffFile = file("build/diff-${nextRev}.patch")
//            diffFile.parentFile.mkdirs()
//            "svn diff -r ${workingRev}:${nextRev} > ${diffFile}".execute().waitFor()
//        }
//    }
//}
//

def altDir = file("${buildDir}/alt-src")
sourceSets {
    alt {
        java {
            srcDirs = ['build/alt-src']
//            outputDir = file('build/classes/java/main') // –ö—É–¥–∞ –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å
        }
    }
}

task compileAltJava2(type: JavaCompile) {
    source = sourceSets.alt.java
    destinationDirectory = file('build/classes/java/main')
    classpath = sourceSets.main.compileClasspath // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π classpath

    options.encoding = 'UTF-8'
    options.compilerArgs += ['-parameters']
}

//// –¶–µ–ª—å alt work
task alt {
    group = 'build'
    description = '–°–æ–∑–¥–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏'

    def replacements = [
            'org.viacheslav.Point': 'org.viacheslav.AltPoint',
            'point'               : 'altpoint',
            'Point'               : 'AltPoint'
    ]

    doLast {
        def srcDir = file("${projectDir}/src/main/java")


        // 1. –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        copy {
            from srcDir
            into altDir
            include '**/*.java'
        }

        // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã –≤–æ –≤—Å–µ—Ö Java-—Ñ–∞–π–ª–∞—Ö
        fileTree(altDir).include('**/*.java').each { file ->
            def content = file.text
            replacements.each { oldStr, newStr ->
                content = content.replaceAll(oldStr, newStr)
            }
            file.text = content
        }

        def sourceFile = file("${altDir}/org/viacheslav/Point.java")
        def destFile = file("${altDir}/org/viacheslav/AltPoint.java")

        // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        destFile.text = sourceFile.text

        sourceFile.delete()

        // 5. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ JAR

        exec { commandLine('./gradlew', 'compileAltJava2') }
        exec { commandLine('jar', 'cfm', "${buildDir}/libs/alt.jar", "${buildDir}/tmp/jar/MANIFEST.MF", '-C', "${buildDir}/classes/java/main", '.') }

//        exec { commandLine('./gradlew', 'jar') }

        println "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–±—Ä–∞–Ω–∞: ${buildDir}/libs/alt.jar"
    }
}



import java.nio.file.Files
import java.text.SimpleDateFormat

task team {
    group = "version control"
    description = "–ü–æ–ª—É—á–∞–µ—Ç 3 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–≤–∏–∑–∏–∏ –∏–∑ SVN, —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ö –∏ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç jar-—Ñ–∞–π–ª—ã."
    def revisionsToFetch = 3
    def baseDir = file("$buildDir/team")
    def zipOutput = file("$buildDir/team-artifacts.zip")
    doLast {
        baseDir.mkdirs()
        def out = new ByteArrayOutputStream()
        exec {
            commandLine "svn", "info", "-r", "HEAD"
            standardOutput = out
        }

        def currentRev = out.toString().readLines().find { it.startsWith("Revision:") }?.split(":")?.last()?.trim()?.toInteger()
        println "üìå –¢–µ–∫—É—â–∞—è —Ä–µ–≤–∏–∑–∏—è SVN: $currentRev"

        def warFiles = []

        (1..revisionsToFetch).each { i ->
            def rev = currentRev - i
            def dir = new File(baseDir, "rev-$rev")
            println "‚¨áÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–≤–∏–∑–∏–∏ $rev –≤ $dir"

            exec {
                commandLine "svn", "export", "-r", "$rev", "file:///home/slava-linux/fse-3/repo/trunk", "build/team/rev-$rev"
            }


            println "üî® –°–±–æ—Ä–∫–∞ —Ä–µ–≤–∏–∑–∏–∏ $rev"
            exec {
                workingDir = dir
                commandLine "./gradlew", "clean", "build", "--no-daemon"
            }

            // –ò—â–µ–º WAR
            def war = new File(dir, "build/libs")
                    .listFiles()
                    ?.find { it.name.endsWith(".war") && !it.name.endsWith("-sources.war") }

            if (war) {
                def renamed = new File(baseDir, "rev-${rev}-${war.name}")
                Files.copy(war.toPath(), renamed.toPath())
                warFiles << renamed
                println "üì¶ JAR –¥–æ–±–∞–≤–ª–µ–Ω: ${renamed.name}"
            } else {
                println "‚ö†Ô∏è JAR –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–≤–∏–∑–∏–∏ $rev"
            }
        }

        println "üìö –ê—Ä—Ö–∏–≤–∞—Ü–∏—è WAR-—Ñ–∞–π–ª–æ–≤ –≤ ${zipOutput.name}"
        ant.zip(destfile: zipOutput) {
            warFiles.each { file ->
                fileset(file: file)
            }
        }

        println "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${zipOutput.absolutePath}"
    }
}


import java.nio.file.Files
import java.text.SimpleDateFormat

task history {
    group = "version control"
    description = "–ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º—É—é —Ä–µ–≤–∏–∑–∏—é –∏ —Å–æ–∑–¥–∞—ë—Ç diff —Å–ª–µ–¥—É—é—â–µ–π."

    def tempDir = file("$buildDir/history")
    def diffFile = file("$buildDir/history-diff.txt")

    doLast {
        tempDir.mkdirs()

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–µ–≤–∏–∑–∏—é
        def revOut = new ByteArrayOutputStream()
        exec {
            commandLine "svn", "info", "-r", "HEAD", "--show-item", "revision"
            standardOutput = revOut
        }
        def headRev = revOut.toString().trim().toInteger()
        println "üîç HEAD —Ä–µ–≤–∏–∑–∏—è: $headRev"

        def workingRev = null

        // –ù–∞—á–∏–Ω–∞–µ–º —Å HEAD –∏ –¥–≤–∏–≥–∞–µ–º—Å—è –Ω–∞–∑–∞–¥
        for (rev in headRev..1) {
            println "‚è™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≤–∏–∑–∏–∏ $rev..."

            def revDir = new File(tempDir, "rev-$rev")
            if (revDir.exists()) revDir.deleteDir()


            exec {
                commandLine "svn", "checkout", "-r", "$rev", "file:///home/slava-linux/fse-3/repo/trunk", "build/team/rev-$rev"
            }

            def result = exec {
                // workingDir = revDir
                commandLine ("./gradlew", "mycompile")
                ignoreExitValue = true
            }

            if (result.exitValue == 0) {
                println "‚úÖ –†–µ–≤–∏–∑–∏—è $rev —É—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è"
                workingRev = rev
                break
            } else {
                println "‚ùå –†–µ–≤–∏–∑–∏—è $rev –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è"
            }
        }

        if (workingRev == null) {
            println "üõë –ù–∏ –æ–¥–Ω–∞ —Ä–µ–≤–∏–∑–∏—è –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è"
            return
        }

        if (workingRev == headRev) {
            println "üéâ –¢–µ–∫—É—â–∞—è HEAD —Ä–µ–≤–∏–∑–∏—è —É–∂–µ —Ä–∞–±–æ—á–∞—è. Diff –Ω–µ –Ω—É–∂–µ–Ω."
            return
        }

        def nextRev = workingRev + 1

        println "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ diff –º–µ–∂–¥—É —Ä–µ–≤–∏–∑–∏–µ–π $workingRev –∏ $nextRev..."

        def diffOut = new ByteArrayOutputStream()
        exec {
            commandLine "svn", "diff", "-r", "$workingRev:$nextRev"
            standardOutput = diffOut
        }

        diffFile.text = diffOut.toString("UTF-8")
        println "üìù Diff —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: ${diffFile.absolutePath}"
    }
}
